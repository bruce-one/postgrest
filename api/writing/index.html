<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="Joe Nelson">
        <link rel="canonical" href="http://postgrest.com/api/writing/">
        <link rel="shortcut icon" href="../../../../favicon.ico">
        

	<title>Writing - PostgREST</title>

        <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.5.0.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="../../css/highlight.css">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->

        
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->
            <a class="navbar-brand" href="../..">PostgREST</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">Home</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Install <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../install/server/">The Server</a>
</li>

                        
                            
<li >
    <a href="../../install/ecosystem/">Ecosystem</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">API <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../reading/">Reading</a>
</li>

                        
                            
<li class="active">
    <a href="./">Writing</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Admin <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../admin/security/">Security</a>
</li>

                        
                            
<li >
    <a href="../../admin/versioning/">Versioning</a>
</li>

                        
                            
<li >
    <a href="../../admin/migration/">Migration</a>
</li>

                        
                            
<li >
    <a href="../../admin/deployment/">Deployment</a>
</li>

                        
                            
<li >
    <a href="../../admin/performance/">Performance</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Examples <b class="caret"></b></a>
                        <ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../examples/start/">Getting Started</a>
</li>

                        
                            
<li >
    <a href="../../examples/users/">User Management</a>
</li>

                        
                            
<li >
    <a href="../../examples/blog/">Multi-Tenant Blog</a>
</li>

                        
                            
<li >
    <a href="../../examples/external_auth/">External Authentication</a>
</li>

                        
                            
<li >
    <a href="../../examples/python-requests-jwt/">Python Client</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>
            

            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                        <i class="fa fa-search"></i> Search
                    </a>
                </li>
                
                    <li >
                        <a rel="next" href="../reading/">
                            <i class="fa fa-arrow-left"></i> Previous
                        </a>
                    </li>
                    <li >
                        <a rel="prev" href="../../admin/security/">
                            Next <i class="fa fa-arrow-right"></i>
                        </a>
                    </li>
                
                
                    <li>
                        <a href="https://github.com/begriffs/postgrest">
                            
                                <i class="fa fa-github"></i>
                            
                            GitHub
                        </a>
                    </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            
                <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#updating-data">Updating Data</a></li>
        
            <li><a href="#record-creation">Record Creation</a></li>
        
            <li><a href="#bulk-insertion">Bulk Insertion</a></li>
        
            <li><a href="#multiple-tables-insertion-or-update">Multiple Tables Insertion or Update</a></li>
        
            <li><a href="#bulk-updates">Bulk Updates</a></li>
        
            <li><a href="#deletion">Deletion</a></li>
        
            <li><a href="#protecting-dangerous-actions">Protecting Dangerous Actions</a></li>
        
    
    </ul>
</div></div>
                <div class="col-md-9" role="main">

<h2 id="updating-data">Updating Data</h2>
<h3 id="record-creation">Record Creation</h3>
<ul>
<li>❌ Cannot be cached or prefetched</li>
<li>❌ Not idempotent</li>
</ul>
<p>To create a row in a database table post a JSON object whose keys
are the names of the columns you would like to create. Missing keys
will be set to default values when applicable.</p>
<pre><code class="HTTP">POST /table_name
{ &quot;col1&quot;: &quot;value1&quot;, &quot;col2&quot;: &quot;value2&quot; }
</code></pre>

<p>The response will include a <code>Location</code> header describing where to
find the new object. If you would like to get the full object back
in the response to your request, include the header <code>Prefer:
return=representation</code>. That way you won't have to make another
HTTP call to discover properties that may have been filled in on
the server side.</p>
<h3 id="bulk-insertion">Bulk Insertion</h3>
<ul>
<li>❌ Cannot be cached or prefetched</li>
<li>❌ Not idempotent</li>
</ul>
<p>You can POST a JSON array or CSV to insert multiple rows in a single
HTTP request. Note that using CSV requires less parsing on the server
and is <strong>much faster</strong>.</p>
<p>Example of CSV bulk insert. Simply post to a table route with
<code>Content-Type: text/csv</code> and include the names of the columns as
the first row. For instance</p>
<pre><code class="HTTP">POST /people
name,age,height
J Doe,62,70
Jonas,10,55
</code></pre>

<p>An empty field (<code>,,</code>) is coerced to an empty string and the reserved
word <code>NULL</code> is mapped to the SQL null value. Note that there should
be no spaces between the column names and commas.</p>
<p>Example of JSON bulk insert. Send an array:</p>
<pre><code class="HTTP">POST /people
[
  { &quot;name&quot;: &quot;J Doe&quot;, &quot;age&quot;: 62, &quot;height&quot;: 70 },
  { &quot;name&quot;: &quot;Janus&quot;, &quot;age&quot;: 10, &quot;height&quot;: 55 }
]
</code></pre>

<p>If you would like to get the full object back in the response to
your request, include the header <code>Prefer: return=representation</code>.
Chances are you only want certain information back, though, like
created ids. You can pass a <code>select</code> parameter to affect the shape
of the response (further documented in the <a href="../../api/reading/">reading</a>
page). For instance</p>
<pre><code class="HTTP">POST /people?select=id
[...]
</code></pre>

<p>returns something like</p>
<pre><code class="json">[ { &quot;id&quot;: 1 }, { &quot;id&quot;: 2 } ]
</code></pre>

<h3 id="multiple-tables-insertion-or-update">Multiple Tables Insertion or Update</h3>
<p>The cleanest way to insert or update data into multiple tables using only one POST/PATCH request
is to create a view that will join all target tables and present a single endpoint.
In our example let's assume one users table and one companies table.
In this case, we want a signup endpoint to create the first user within a company.
And for this endpoint we want to insert with one request both user and company.</p>
<pre><code class="SQL">CREATE TABLE companies (
    id serial primary key,
    name text unique
);

CREATE TABLE users (
    id serial primary key,
    name text not null,
    pass text,
    company_id integer not null references companies
);
</code></pre>

<p>Having both tables created we create a view that joins them to be used
as a <code>/signup</code> endpoint.</p>
<pre><code class="SQL">CREATE VIEW signup AS
    SELECT
        c.name AS company_name,
        u.name AS user_name,
        u.pass
    FROM
        public.users u
        JOIN public.companies c ON c.id = u.company_id;

</code></pre>

<p>After the signup view creation, we can issue <code>GET</code> requests to read data
from users and companies, but any attempt to <code>POST</code> or <code>PATCH</code> data will fail.
PostgreSQL won't allow any data change on views that have a <code>JOIN</code> 
clause in their <code>FROM</code> without a proper <code>INSTEAD OF</code> trigger.
So in the example bellow we create a trigger to allow insertion of data in the signup view.
The trigger is a simple PL/pgSQL function that first inserts into the companies table and
uses the newly create company_id to create its first user.</p>
<pre><code class="SQL">CREATE FUNCTION signup()
RETURNS trigger
LANGUAGE plpgsql
AS $$
DECLARE
  vcompany_id int;
BEGIN
  INSERT INTO companies (name) VALUES (new.company_name) RETURNING id INTO vcompany_id;
  INSERT INTO users (name, pass, company_id) VALUES (new.user_name, new.pass, vcompany_id);
RETURN new;
END;
$$;

CREATE TRIGGER signup
INSTEAD OF INSERT ON signup
FOR EACH ROW
EXECUTE PROCEDURE signup();
</code></pre>

<p>After the trigger creation we can issue a normal <code>POST</code> request to our signup endpoint:</p>
<pre><code class="HTTP">POST /signup
{ &quot;company_name&quot;: &quot;foo&quot;, &quot;user_name&quot;: &quot;bar&quot; }
</code></pre>

<p>For an endpoint such as signup its usually not desirable to have a <code>PATCH</code> route for updates,
and we will skip this example for the sake of brevity. But it would be implemented in a very
similar way to our <code>POST</code> example.</p>
<div class="admonition note">
    <p class="admonition-title">Design Consideration</p>

    <p>It's advisable to create a separate trigger for <code>UPDATE</code> and <code>INSERT</code>
    avoiding conditionals that decide which is the trigger current operation.
    This makes it easier to change code for (or even disable) one operation without interfering with others while
    improving readability.
    </p>
</div>

<h3 id="bulk-updates">Bulk Updates</h3>
<ul>
<li>❌ Cannot be cached or prefetched</li>
<li>❌ Not idempotent</li>
</ul>
<p>To change parts of a resource or resources use the <code>PATCH</code> verb.
For instance, here is how to mark all young people as children.</p>
<pre><code class="HTTP">PATCH /people?age=lt.13
{
  &quot;person_type&quot;: &quot;child&quot;
}
</code></pre>

<p>This affects any rows matched by the url param filters, overwrites
any fields specified in in the payload JSON and leaves the other
fields unaffected. Note that although the payload is not in the
JSON patch format specified by
<a href="https://tools.ietf.org/html/rfc6902">RFC6902</a>, HTTP does not specify
which patch format to use. Our format is more pleasant, meant for
basic field replacements, and not at all "incorrect."</p>
<h3 id="deletion">Deletion</h3>
<ul>
<li>❌ Cannot be cached or prefetched</li>
<li>✅ Idempotent</li>
</ul>
<p>Simply use the <code>DELETE</code> verb. All records that match your filter
will be removed. For instance deleting inactive users:</p>
<pre><code class="HTTP">DELETE /user?active=is.false
</code></pre>

<h3 id="protecting-dangerous-actions">Protecting Dangerous Actions</h3>
<p>Notice that it is very easy to delete or update many records at
once. In fact forgetting a filter will affect an entire table!</p>
<div class="admonition warning">
    <p class="admonition-title">Invitation to Contribute</p>

    <p>We would like to investigate nginx rules to guard dangerous
    actions, perhaps requiring a confirmation header or query param
    to perform the action.</p>

    <p>You're invited to research this option and contribute to
    this documentation.</p>
</div></div>
            
        </div>

        <footer class="col-md-12">
            <hr>
            
            <p>Documentation built with <a href="http://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>

        <script src="../../js/jquery-1.10.2.min.js"></script>
        <script src="../../js/bootstrap-3.0.3.min.js"></script>
        <script src="../../js/highlight.pack.js"></script>
        <script>var base_url = '../..';</script>
        <script data-main="../../mkdocs/js/search.js" src="../../mkdocs/js/require.js"></script>
        <script src="../../js/base.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="Search Modal" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                        <h4 class="modal-title" id="exampleModalLabel">Search</h4>
                    </div>
                    <div class="modal-body">
                        <p>
                            From here you can search these documents. Enter
                            your search terms below.
                        </p>
                        <form role="form">
                            <div class="form-group">
                                <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query">
                            </div>
                        </form>
                        <div id="mkdocs-search-results"></div>
                    </div>
                    <div class="modal-footer">
                    </div>
                </div>
            </div>
        </div>

    </body>
</html>
